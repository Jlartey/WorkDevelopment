sql = "WITH PatientAgeGroupCTE AS "
sql = sql & "( "
sql = sql & "SELECT "
sql = sql & "    YEAR(Visitdate) AS VISIT_YEAR, "
sql = sql & "    DBO.AgeGroupJoseph(PatientAge) AS PATIENT_AGEGROUP, "
sql = sql & "    COUNT(DBO.AgeGroupJoseph(PatientAge)) AS PATIENT_COUNT "
sql = sql & "FROM Visitation "
sql = sql & "WHERE Visitdate "
sql = sql & "    BETWEEN '2018-01-01' AND '2024-05-01' "
sql = sql & "GROUP BY "
sql = sql & "    YEAR(Visitdate), "
sql = sql & "    DBO.AgeGroupJoseph(PatientAge) "
sql = sql & "--ORDER BY PATIENT_AGEGROUP, VISIT_YEAR "
sql = sql & ") "
sql = sql & "SELECT "
sql = sql & "    VISIT_YEAR, "
sql = sql & "    PATIENT_AGEGROUP, "
sql = sql & "    PATIENT_COUNT, "
sql = sql & "    LAG(PATIENT_COUNT) OVER(PARTITION BY PATIENT_AGEGROUP ORDER BY PATIENT_AGEGROUP, VISIT_YEAR) AS PREV_COUNT, "
sql = sql & "    PATIENT_COUNT - LAG(PATIENT_COUNT) OVER(PARTITION BY PATIENT_AGEGROUP ORDER BY PATIENT_AGEGROUP, VISIT_YEAR) AS DIFFERENCE, "
sql = sql & "    (PATIENT_COUNT - LAG(PATIENT_COUNT) OVER(PARTITION BY PATIENT_AGEGROUP ORDER BY PATIENT_AGEGROUP, VISIT_YEAR)) * 100.00 / PATIENT_COUNT AS PERCENTAGE_CHANGE "
sql = sql & "FROM PatientAgeGroupCTE "
sql = sql & "--ORDER BY PATIENT_AGEGROUP, VISIT_YEAR"
