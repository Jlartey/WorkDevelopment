sql = "WITH DoctorConsults AS ( "
sql = sql & "SELECT DISTINCT SystemUserID, VisitationID "
sql = sql & "From EMRRequestItems "
sql = sql & "WHERE EMRDataID IN ('TH060', 'IM051', 'TH082', 'TH069', 'TH067', 'IM048', 'IM011', 'TH087', 'TH088', 'TH088B', 'TH085', 'TH072') "
sql = sql & ") "
sql = sql & "SELECT DISTINCT sp.SpecialistTypeName AS [Consultation Type], "
sql = sql & "CAST(CONVERT(DATE, vst.VisitDate) AS VARCHAR) AS [Date of Consultation], "
sql = sql & "Patient.PatientID AS [Patient ID], "
sql = sql & "Patient.PatientName AS [Patient Name], "
sql = sql & "vst.PatientAge AS [Age], gen.GenderName AS [Sex], "
sql = sql & "VisitType.VisitTypeName AS [First/Follow Up], "
sql = sql & "vst.VisitationID AS [Diagnosis], "
sql = sql & "(SELECT TOP 1 dg.DiagnosisType "
sql = sql & " FROM Diagnosis AS dg "
sql = sql & " WHERE dg.VisitationID = vst.VisitationID "
sql = sql & " ORDER BY dg.ConsultReviewID) AS [Diagnosis Type], "
sql = sql & "(SELECT TOP 1 temp.temperature "
sql = sql & " FROM ( "
sql = sql & "    SELECT DISTINCT visitationid, CONVERT(NVARCHAR(MAX), Column3) AS Temperature "
sql = sql & "    FROM EMRResults AS emrres "
sql = sql & "    JOIN EMRRequest emrreq ON emrres.EMRRequestID = emrreq.EMRRequestID "
sql = sql & "    WHERE emrdataid = 'EMR034' AND EMRComponentID = 'EMR03410' "
sql = sql & " ) AS temp "
sql = sql & " WHERE temp.visitationid = vst.VisitationID "
sql = sql & " ORDER BY temp.visitationid) AS [Temperature], "
sql = sql & "(SELECT TOP 1 wg.weight12 "
sql = sql & " FROM ( "
sql = sql & "    SELECT DISTINCT visitationid, CONVERT(NVARCHAR(MAX), Column2) AS Weight12 "
sql = sql & "    FROM EMRResults AS emrres "
sql = sql & "    JOIN EMRRequest emrreq ON emrres.EMRRequestID = emrreq.EMRRequestID "
sql = sql & "    WHERE emrdataid = 'EMR034' AND EMRComponentID = 'EMR05003' "
sql = sql & " ) AS wg "
sql = sql & " WHERE wg.visitationid = vst.VisitationID "
sql = sql & " ORDER BY wg.visitationid) AS [Weight], "
sql = sql & "(SELECT TOP 1 ht.height "
sql = sql & " FROM ( "
sql = sql & "    SELECT DISTINCT visitationid, CONVERT(NVARCHAR(MAX), Column4) AS height "
sql = sql & "    FROM EMRResults AS emrres "
sql = sql & "    JOIN EMRRequest emrreq ON emrres.EMRRequestID = emrreq.EMRRequestID "
sql = sql & "    WHERE emrdataid = 'EMR034' AND EMRComponentID = 'EMR05004' "
sql = sql & " ) AS ht "
sql = sql & " WHERE ht.visitationid = vst.VisitationID "
sql = sql & " ORDER BY ht.visitationid) AS [Height], "
sql = sql & "vst.VisitationID AS [Investigations Requested], "
sql = sql & "vst.VisitationID AS [Medications], mo.MedicalOutcomeName AS [Outcome], "
sql = sql & "spn.SponsorName AS [Insurance Status], "
sql = sql & " (SELECT TOP 1 Staff.StaffName"
sql = sql & " FROM DoctorConsults dc"
sql = sql & " JOIN SystemUser ON SystemUser.SystemUserID = dc.SystemUserID"
sql = sql & " JOIN Staff ON Staff.StaffID = SystemUser.StaffID"
sql = sql & " WHERE dc.VisitationID = vst.VisitationID) AS [Attending Doctor],"
sql = sql & "Patient.ResidencePhone AS [Patient Tel.] "
sql = sql & "FROM Visitation AS vst "
sql = sql & "LEFT JOIN Patient ON Patient.PatientID = vst.PatientID "
sql = sql & "LEFT JOIN Gender AS gen ON gen.GenderID = vst.GenderID "
sql = sql & "LEFT JOIN VisitType ON vst.VisitTypeID = VisitType.VisitTypeID "
sql = sql & "LEFT JOIN SpecialistType AS sp ON sp.SpecialistTypeID = vst.SpecialistTypeID "
sql = sql & "LEFT JOIN MedicalOutcome AS mo ON mo.MedicalOutcomeID = vst.MedicalOutcomeID "
sql = sql & "LEFT JOIN SystemUser AS su ON su.SystemUserID = vst.SpecialistID "
sql = sql & "LEFT JOIN Sponsor AS spn ON spn.SponsorID = vst.SponsorID "
sql = sql & "WHERE vst.VisitDate BETWEEN '" & dateRange(0) & "' AND '" & dateRange(1) & "' "
sql = sql & "    AND vst.PatientID <> 'P3' "
If ageGroup <> "" Then sql = sql & "    AND vst.AgeGroupID='" & ageGroup & "' "
If spType <> "" Then sql = sql & "    AND vst.SpecialistTypeID='" & spType & "' "
sql = sql & "ORDER BY CAST(CONVERT(DATE, vst.VisitDate) AS VARCHAR) ASC, Patient.PatientName ASC "
    ConsultationReportSQL = sql
End Function
